#!/bin/sh
#-
# SPDX-License-Identifier: BSD-2-Clause
#
# Copyright (c) 2025-2026 The FreeBSD Foundation
#
# This software was developed by Alfonso Sabato Siciliano
# under sponsorship from the FreeBSD Foundation.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
#
# THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND
# ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
# ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE
# FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
# OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
# HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
# LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
# OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
# SUCH DAMAGE.
#

# Include for $OSNAME
BSDCFG_SHARE="/usr/share/bsdconfig"
. $BSDCFG_SHARE/common.subr || exit 1

readonly BSDDIALOG_OK=0
readonly BSDDIALOG_YES=$BSDDIALOG_OK
readonly BSDDIALOG_NO=1

readonly XDRIVERFILE=/usr/local/etc/X11/xorg.conf.d/20-installerdriver.conf

####
# 1. Yes-No question and Checks.
# 2. Select GPU driver.
# 3. Installation.
# 4. Global Configuration.
# 5. Configuration for users.
# 6. Success message.
####

#### SECTION 1: Yes-No question and Checks ####
QUESTION="FreeBSD provides a variety of graphical environments that can
be easily installed through ports and packages. Refer to the FreeBSD
Handbook available at \Zuhttps://docs.freebsd.org\Zn.\n\n
Would you like to install the GPU drivers, Xorg, KDE Plasma, and SDDM
now, and have them start automatically at the next system reboot?\n\n
Please note this is an experimental feature."
bsddialog --backtitle "$OSNAME Installer" --title Desktop --colors \
	--yesno "$QUESTION" 0 0
[ $? -ne $BSDDIALOG_YES ] && exit 1

if [ -z "$(hostname)" ]; then
	bsddialog --backtitle "FreeBSD Installer" --title Desktop \
	--ok-label Exit --msgbox "Please set a hostname." 0 0
	exit 1
fi

# TODO: check arch for gpu drivers.
# TODO: check CURRENT for available packages.

#### SECTION 2: Select GPU ####
PKGGPU=`fwget -n -q | grep gpu`
BOOTMETHOD=`sysctl -n machdep.bootmethod`
# F1 help message
HELPGPU="\ZbSystem firmware boot method\Zn: $BOOTMETHOD

\ZbGPU\Zn:
`pciconf -lv | grep -A 4 vga`

\ZbDetected firmware package\Zn: $PKGGPU"
# end F1 help message

# TODO: add auto detection, via pciconf -lv and fwget -n -q
# TODO: check boot method to show only vesa or scfb
# TODO: check virtual machine, sysctl kern.vm_guest=vbox
if [ `sysctl -n kern.vm_guest` = vbox ]; then
	virtualbox=on
fi
gpu=$(bsddialog --backtitle "$OSNAME Installer" --title Desktop \
	--ok-label Install --cancel-label Exit \
	--colors --hmsg "$HELPGPU" --item-depth \
	--radiolist "F1 to know your GPU, SPACE to select a driver:" 0 0 0 \
	0 DRM           "Intel and AMD Metaport"                         off \
	1 Intel         "Intel APUs starting with HD3000 / Sandy Bridge" off \
	1 AMD           "AMD GPUs starting with HD7000 / Tahiti"         off \
	1 Radeon        "Older AMD GPUs (EFI boot should be disabled)"   off \
	0 NVIDIA        "Proprietary driver "                            off \
	1 Optimus-Intel "Nvidia Optimus and Intel GPU"                   off \
	0 VirtualBox    "Oracle VirtualBox."                             ${virtualbox-off} \
	0 VESA          "GPU not supported by other drivers (BIOS)"      off \
	0 SCFB          "GPU not supported by other drivers (UEFI)"      off \
	3>&1 1>&2 2>&3 3>&-)
[ $? -ne $BSDDIALOG_OK ] && exit 1
[ -z $gpu ] && exit 0

toinstall=""
postconfig=""
case $gpu in
	DRM)
		toinstall="drm-kmod mesa-gallium-va libva-utils libva-intel-media-driver"
		postconfig="sysrc kld_list+=\"i915kms amdgpu radeonkms\""
		;;
	Optimus-Intel)
		optimus=1
		;&
	Intel)
		toinstall="drm-kmod mesa-gallium-va libva-utils libva-intel-media-driver"
		postconfig="sysrc kld_list+=\"i915kms\""
		;;
	AMD)
		toinstall="drm-kmod mesa-gallium-va libva-utils"
		postconfig="sysrc kld_list+=\"amdgpu\""
		;;
	Radeon)
		toinstall="drm-kmod mesa-gallium-va libva-utils"
		postconfig="sysrc kld_list+=\"radeonkms\""
		;;
	VirtualBox)
		toinstall="virtualbox-ose-additions"
		postconfig="sysrc vboxguest_enable=\"YES\" ; sysrc vboxservice_enable=\"YES\""
		;;
	VESA)
		toinstall="xf86-video-vesa"
		postconfig="printf 'Section \"Device\"\n\tIdentifier \"Card0\"\n\tDriver \"vesa\"\nEndSection' >> $XDRIVERFILE"
		;;
	SCFB)
		toinstall="xf86-video-scfb"
		postconfig="printf 'Section \"Device\"\n\tIdentifier \"Card0\"\n\tDriver \"scfb\"\nEndSection' >> $XDRIVERFILE"
		;;
esac

HELPGPU="$HELPGPU

\ZbSupported GPUs\Zn:
 * nvidia-drm-drm: \Zuhttps://www.nvidia.com/en-us/drivers/details/210651/\Zn
 * nvidia-driver-470: \Zuhttps://www.nvidia.com/en-us/drivers/details/194639/\Zn
 * nvidia-driver-390: \Zuhttps://www.nvidia.com/en-us/drivers/details/191122/\Zn
 * nvidia-driver-340: \Zuhttps://www.nvidia.com/en-us/drivers/details/156167/\Zn
 * nvidia-driver-304: \Zuhttps://www.nvidia.com/en-us/drivers/details/123712/\Zn"

if [ $gpu = NVIDIA -o $optimus ]; then
	# 580 no in handbook.
	items="Untested nvidia-drm-kmod 'Proprietary driver for recent GPUs' off \
	Untested nvidia-driver-470 'Old proprietary driver version 470' off \
	Untested nvidia-driver-390 'Old proprietary driver version 390' off \
	Untested nvidia-driver-340 'Old proprietary driver version 340' off \
	Untested nvidia-driver-304 'Old proprietary driver version 304' off"

	gpu=$(echo $items | xargs -o bsddialog --backtitle "$OSNAME Installer" \
		--title Desktop --ok-label Install --cancel-label Exit \
		--colors --hmsg "$HELPGPU" --item-prefix \
		--radiolist "F1 to know your GPU and which driver supports it.
		SPACE to select a driver." \
		0 0 0 \
		3>&1 1>&2 2>&3 3>&-)
	[ $? -ne $BSDDIALOG_OK -o -z $gpu ] && exit 0

	toinstall="$toinstall $gpu"
	version=${gpu##nvidia-driver-}
	# refactor importing to bsdinstall
	if [ $version = "nvidia-drm-kmod" ]; then
		# Handbook: when nvidia-drm or nvidia-modeset?
		kmod=nvidia-drm
	elif [ $version -ge 390 ]; then
		kmod=nvidia-modeset
	else
		# 304 and 340.
		# Available for OPTIMUS?
		# Handbook: with the legacy sc(4) console driver, and a
		# x11/xorg-server version prior to 1.20.
		kmod=nvidia
	fi

	if [ $optimus ]; then
		postconfig="$postconfig ; echo hw.nvidiadrm.modeset=\\\"1\\\" >> /boot/loader.conf"
		postconfig="$postconfig ; sysrc kld_list+=\"i915kms $kmod\""
	else
		postconfig="sysrc kld_list+=\"$kmod\""
	fi
fi

#### SECTION 3: Installation ####
ASSUME_ALWAYS_YES=yes pkg update
pkg install $toinstall kde plasma6-plasma sddm wireplumber xorg
[ $? -ne 0 ] && exit 0

#### SECTION 4: Global Configuration ####
bsddialog --backtitle "$OSNAME Installer" --title Desktop \
	--infobox "Create and update configuration files" 0 0

# Delete the previous configurations if this script has been called before
# using finalconfig menu script.
# Is this really necessary? Does bsdinstall provide a reset or restart option?
sysrc-=" i915kms amdgpu radeonkms nvidia-drm nvidia-modeset nvidia"
rm -f $XDRIVERFILE
sed -i '' '/hw.nvidiadrm.modeset="1"/d' /boot/loader.conf
sed -i '' '/# VirtualBox setup/d' /boot/loader.conf
sed -i '' '/hw.efi.poweroff=0/d' /boot/loader.conf

eval $postconfig
sysrc dbus_enable="YES"
sysrc sddm_enable="YES"
grep -qxF "# KDE setup" /etc/sysctl.conf || {
	echo "# KDE setup";
	echo "net.local.stream.recvspace=65536";
	echo "net.local.stream.sendspace=65536";
} >> /etc/sysctl.conf

if [ $gpu = VirtualBox ]; then
	bsddialog --backtitle "$OSNAME Installer" --title Desktop \
	--msgbox "VirtualBox setting: select VBoxSVGA as graphics controller,
	and disable 3D acceleration." \
	0 0
fi

#### SECTION 5: For User Configuration ####
USERS=`pw usershow -a | awk -F":" '$NF != "/usr/sbin/nologin" && $3 > 999 {print $1 " \""$8"\" off"}' | sort`

exec 5>&1
users=$(echo ${USERS} | xargs -o bsddialog --backtitle "$OSNAME Installer" \
	--title Desktop --ok-label Close --no-cancel \
	--checklist "SPACE to select the users enabled for the graphical environment:" \
	0 0 0 \
	2>&1 1>&5)
exec 5>&-
[ $? -ne $BSDDIALOG_OK -o -z "$users" ] && exit 0

if [ $gpu != VESA -a $gpu != SCFB -a $gpu != VirtualBox ]; then
	pw groupmod video -m `echo "$users" | tr ' ' ','`
fi

if [ $gpu = VirtualBox ]; then
	pw groupmod wheel -m `echo "$users" | tr ' ' ','`
	# Useful for poweroff(8). Is this script the right place for this setting?
	if [ `sysctl -n machdep.bootmethod` = UEFI ]; then
		{ 
			echo "# VirtualBox setup";
			echo "hw.efi.poweroff=0";
		} >> /boot/loader.conf
	fi
fi

gen_autostart_entry() {
	cat <<EOF
[Desktop Entry]
Name=$1
Comment=$2
Exec=$3
Terminal=false
Type=Application
X-GNOME-Autostart-Phase=Initialization
X-KDE-autostart-phase=1
Version=1.0
$4
EOF
}

for u in $users; do
	user_home="$(pw usershow ${u} | awk -F: '{print $(NF-1)}')"
	user_config_dir="/mnt/${user_home}/.config"
	mkdir -p "${user_config_dir}/autostart"
	gen_autostart_entry \
		'PipeWire Media System' \
		'Start the PipeWire Media System' \
		pipewire > "${user_config_dir}/autostart/pipewire.desktop"
	gen_autostart_entry \
		'PipeWire PulseAudio replacement' \
		'Start the PulseAudio-compatible PipeWire daemon' \
		pipewire-pulse > "${user_config_dir}/autostart/pipewire-pulse.desktop"
	gen_autostart_entry \
		'PulseAudio Sound System' \
		'Start the PulseAudio Sound System' \
		'start-pulseaudio-x11' \
		'Hidden=true' > "${user_config_dir}/autostart/pulseaudio.desktop"
	chown -R ${u}:${u} "${user_config_dir}"
done

#### SECTION 6: Success Message ####
bsddialog --backtitle "$OSNAME Installer" --title Desktop \
	--msgbox "\nDesktop installation completed.\n\nThe SDDM display
	manager will start automatically and allow graphical login at the next
	startup. The enabled users with configured settings are: ${users}." \
	0 0
